<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>AVIF è½¬æ¢å™¨ï¼ˆå¸¦å¤§å°å¯¹æ¯”ï¼‰</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #2c3e50;
    }
    #status {
      margin: 10px 0;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
      min-height: 20px;
    }
    #preview {
      max-width: 100%;
      max-height: 400px;
      margin: 10px 0;
      display: none;
      border: 1px solid #ddd;
    }
    #output {
      width: 100%;
      height: 120px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
    }
    button {
      margin-top: 10px;
      padding: 6px 12px;
    }
    .size-info {
      margin-top: 10px;
      padding: 10px;
      background-color: #e6f7ff;
      border: 1px solid #b3e0ff;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>AVIF è½¬æ¢å™¨ï¼ˆå¸¦å‹ç¼©å¯¹æ¯”ï¼‰</h1>
  <p>ä¸Šä¼  PNG/JPEG/WebP å›¾ç‰‡ï¼Œè‡ªåŠ¨è½¬ä¸º AVIF å¹¶æ˜¾ç¤ºå¤§å°å¯¹æ¯”</p>

  <input type="file" id="fileInput" accept="image/*" />
  <button id="convertBtn" disabled>è½¬æ¢ä¸º AVIF</button>

  <div id="status">åŠ è½½ç¼–ç å™¨ä¸­...</div>

  <img id="preview" />

  <textarea id="output" placeholder="AVIF Base64 å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>

  <script type="module">
    // ä½¿ç”¨ä½ æä¾›çš„ CDN åœ°å€
    const JS_URL = 'https://cdn.jsdelivr.net/gh/m4k15y6666fk/avif-encoder.js@master/dist/core/encoder.js';

    let to_avif = null;
    const statusEl = document.getElementById('status');

    // åŠ è½½å¹¶åˆå§‹åŒ–ç¼–ç å™¨
    async function loadEncoder() {
      try {
        const module = await import(JS_URL);
        console.log('âœ… æ¨¡å—åŠ è½½æˆåŠŸ:', module);

        // åˆå§‹åŒ– WebAssembly
        await module.default();

        // è·å– to_avif å‡½æ•°
        to_avif = module.to_avif;

        statusEl.textContent = 'âœ… AVIF ç¼–ç å™¨å·²å°±ç»ª';
        document.getElementById('convertBtn').disabled = false;
      } catch (err) {
        console.error('âŒ åŠ è½½å¤±è´¥:', err);
        statusEl.textContent = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
      }
    }

    // ä»å›¾ç‰‡ URL è·å–åƒç´ æ•°æ®
    function getImageDataFromUrl(imgUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          resolve({ data: imageData.data, width: img.width, height: img.height });
        };
        img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        img.src = imgUrl;
      });
    }

    // è½¬æ¢å›¾ç‰‡
    async function convertImage() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;

      try {
        statusEl.textContent = 'ğŸ”„ æ­£åœ¨è½¬æ¢...';
        document.getElementById('convertBtn').disabled = true;

        // è¯»å–ä¸º Data URLï¼ˆç”¨äº canvas ç»˜åˆ¶ï¼‰
        const reader = new FileReader();
        const dataUrl = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        // è·å–åŸå§‹æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        const originalSizeBytes = file.size;

        // è·å–åƒç´ æ•°æ®
        const { data, width, height } = await getImageDataFromUrl(dataUrl);

        // è°ƒç”¨ to_avif è¿›è¡Œç¼–ç 
        const avifBytes = to_avif(data, width, height, 70, 6, false); // quality=70, speed=6, alpha=false

        // è½¬ä¸º Base64
        const binary = String.fromCharCode(...new Uint8Array(avifBytes));
        const avifBase64 = 'data:image/avif;base64,' + btoa(binary);
        const avifSizeBytes = avifBytes.length;

        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview');
        preview.src = avifBase64;
        preview.style.display = 'block';

        // è¾“å‡º Base64
        const output = document.getElementById('output');
        output.value = avifBase64;

        // æ¸…é™¤æ—§çš„ size-info
        const oldInfo = document.querySelector('.size-info');
        if (oldInfo) oldInfo.remove();

        // åˆ›å»ºå¤§å°å¯¹æ¯”ä¿¡æ¯
        const sizeInfo = document.createElement('div');
        sizeInfo.className = 'size-info';
        const ratio = (1 - avifSizeBytes / originalSizeBytes) * 100;
        sizeInfo.innerHTML = `
          <p><strong>åŸå§‹æ–‡ä»¶å¤§å°ï¼š</strong> ${(originalSizeBytes / 1024).toFixed(2)} KB</p>
          <p><strong>AVIF å‹ç¼©åå¤§å°ï¼š</strong> ${(avifSizeBytes / 1024).toFixed(2)} KB</p>
          <p><strong>å‹ç¼©ç‡ï¼š</strong> ${ratio >= 0 ? ratio.toFixed(1) : 'è´Ÿï¼ˆå˜å¤§ï¼‰'}%</p>
        `;

        // æ’å…¥åˆ° status ä¸Šæ–¹
        statusEl.parentNode.insertBefore(sizeInfo, statusEl);

        statusEl.textContent = 'âœ… è½¬æ¢æˆåŠŸï¼';
      } catch (err) {
        console.error('è½¬æ¢å¤±è´¥:', err);
        statusEl.textContent = `âŒ è½¬æ¢å¤±è´¥: ${err.message}`;
      } finally {
        document.getElementById('convertBtn').disabled = false;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadEncoder();
      const fileInput = document.getElementById('fileInput');
      const convertBtn = document.getElementById('convertBtn');

      fileInput.addEventListener('change', () => {
        convertBtn.disabled = !to_avif || !fileInput.files.length;
      });

      convertBtn.addEventListener('click', convertImage);
    });
  </script>
</body>
</html>